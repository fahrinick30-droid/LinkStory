<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Store - Akses Cepat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            margin: 0;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .notif-badge {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 5px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .slide-down {
            animation: slideDown 0.5s ease-out forwards;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .crop-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #0f172a;
            overflow: hidden;
            border-radius: 1rem;
            cursor: move;
        }
        .crop-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #10b981;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            pointer-events: none;
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .skeleton-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxq2n3kzAG5R50oxk2_CHcxV5n3oorc1VwJu2IW3az2XMjxZcCGpW9WrdCV2G7pyG6i/exec";
        const STORE_ID = "46ab0f5c-98f9-4e03-a67a-06a7669ae062";
        const NOTIF_SOUND_URL = "https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3";

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconUrl = `https://raw.githubusercontent.com/lucide-icons/lucide/main/icons/${name}.svg`;
            return <img src={iconUrl} alt={name} style={{ width: size, height: size }} className={className} />;
        };

        function App() {
            // 1. Initial States
            const [view, setView] = useState('store'); 
            const [adminTab, setAdminTab] = useState('products'); 
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [paymentConfig, setPaymentConfig] = useState({ 
                bankName: '', bankAccount: '', bankHolder: '', 
                qrisNotes: '', qrisUrl: '', 
                danaNumber: '', danaHolder: '',
                isBankActive: true, isQrisActive: true, isDanaActive: false
            });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [soundEnabled, setSoundEnabled] = useState(false);
            const [appNotification, setAppNotification] = useState('');
            
            // UI States
            const [secretClickCount, setSecretClickCount] = useState(0);
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [cropData, setCropData] = useState({ show: false, src: null, scale: 1, x: 0, y: 0 });
            const [isSavingCrop, setIsSavingCrop] = useState(false);
            const cropImgRef = useRef(null);

            const [showModal, setShowModal] = useState(null);
            const [step, setStep] = useState('form'); 
            const [selectedMethod, setSelectedMethod] = useState(null);
            const [proofImage, setProofImage] = useState(null);
            const [isCompressing, setIsCompressing] = useState(false);
            const [isActionLoading, setIsActionLoading] = useState(false);
            const [buyerData, setBuyerData] = useState({ name: '', phone: '', school: '' });

            const [productForm, setProductForm] = useState({ id: '', name: '', url: '', price: '', stock: '', image: '' });
            const [isEditing, setIsEditing] = useState(false);

            // Compute pendingCount
            const pendingCount = orders.filter(o => String(o.status).toLowerCase() === 'pending').length;
            const lastPendingCountRef = useRef(0);

            const playSound = () => {
                if (soundEnabled) {
                    const audio = new Audio(NOTIF_SOUND_URL);
                    audio.play().catch(e => {});
                }
            };

            const fetchData = async () => {
                try {
                    const res = await fetch(`${SCRIPT_URL}?action=getData&storeId=${STORE_ID}&_=${Date.now()}`);
                    const data = await res.json();
                    if (data && data.status !== "error") {
                        setProducts(data.products || []);
                        const newOrders = data.orders || [];
                        const currentPending = newOrders.filter(o => String(o.status).toLowerCase() === 'pending').length;
                        if (currentPending > lastPendingCountRef.current) playSound();
                        lastPendingCountRef.current = currentPending;
                        setOrders(newOrders);
                        
                        if (data.config) {
                            const cfg = data.config;
                            setPaymentConfig(prev => ({
                                ...prev,
                                bankName: cfg.bankName || '',
                                bankAccount: cfg.bankAccount || '',
                                bankHolder: cfg.bankHolder || '',
                                qrisNotes: cfg.qrisNotes || '',
                                qrisUrl: cfg.qrisUrl || '',
                                danaNumber: cfg.danaNumber || '',
                                danaHolder: cfg.danaHolder || '',
                                isBankActive: cfg.isBankActive === 'true' || cfg.isBankActive === true,
                                isQrisActive: cfg.isQrisActive === 'true' || cfg.isQrisActive === true,
                                isDanaActive: cfg.isDanaActive === 'true' || cfg.isDanaActive === true,
                            }));
                        }
                        setError(null);
                    } else {
                        setError(data.message || "Gagal mengambil data.");
                    }
                    setLoading(false);
                } catch (e) {
                    setError("Koneksi gagal. Cek Deployment Google Script.");
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000); 
                return () => clearInterval(interval);
            }, [soundEnabled]);

            const handlePost = async (payload) => {
                try {
                    const res = await fetch(SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        body: JSON.stringify({ ...payload, storeId: STORE_ID }) 
                    });
                    return true;
                } catch (e) { return false; }
            };

            const handleSecretClick = () => {
                const newCount = secretClickCount + 1;
                setSecretClickCount(newCount);
                if (newCount >= 5) {
                    setView(view === 'admin' ? 'store' : 'admin');
                    setSecretClickCount(0);
                    if (view !== 'admin') {
                        setSoundEnabled(true);
                        fetchData();
                    }
                }
                setTimeout(() => setSecretClickCount(0), 3000);
            };

            const saveProduct = async () => {
                const { id, name, url, price, stock, image } = productForm;
                if(!name || !url || !price || !stock) return alert("Lengkapi data produk!");

                setLoading(true);
                const actionType = isEditing ? 'updateProduct' : 'addProduct';
                const success = await handlePost({ 
                    action: actionType, 
                    id: isEditing ? id : undefined,
                    name, url, price: Number(price), stock: Number(stock), image
                });

                if (success) {
                    setAppNotification(isEditing ? "PRODUK DIPERBARUI!" : "PRODUK DITAMBAHKAN!");
                    setTimeout(() => setAppNotification(''), 3000);
                    setProductForm({ id: '', name: '', url: '', price: '', stock: '', image: '' });
                    setIsEditing(false);
                    setTimeout(fetchData, 2000);
                } else {
                    alert("Gagal menyimpan data.");
                    setLoading(false);
                }
            };

            const startEditProduct = (p) => {
                setProductForm({ id: p.id || '', name: p.name || '', url: p.url || '', price: p.price || '', stock: p.stock || '', image: p.image || '' });
                setIsEditing(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const confirmDelete = async () => {
                if (!deleteTarget) return;
                setLoading(true);
                const productId = deleteTarget.id;
                const deleteName = deleteTarget.name;
                setDeleteTarget(null);
                const success = await handlePost({ action: 'deleteProduct', id: productId });
                if (success) {
                    setAppNotification(`PRODUK "${deleteName}" DIHAPUS.`);
                    setTimeout(() => setAppNotification(''), 3000);
                    setTimeout(fetchData, 2000);
                } else {
                    alert("Gagal menghapus.");
                    setLoading(false);
                }
            };

            const savePaymentConfig = async () => {
                setLoading(true);
                const success = await handlePost({ action: 'updateConfig', ...paymentConfig });
                if (success) {
                    setAppNotification("PENGATURAN DISIMPAN!");
                    setTimeout(() => setAppNotification(''), 3000);
                    setTimeout(fetchData, 2000);
                } else {
                    alert("Gagal menyimpan pengaturan.");
                    setLoading(false);
                }
            };

            const handleCropSave = () => {
                setIsSavingCrop(true);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = cropImgRef.current;
                canvas.width = 400; canvas.height = 400;
                const zoom = cropData.scale;
                ctx.fillStyle = "white"; ctx.fillRect(0,0, 400, 400);
                const drawW = img.naturalWidth * zoom;
                const drawH = img.naturalHeight * zoom;
                const centerX = 200 + (cropData.x * 2);
                const centerY = 200 + (cropData.y * 2);
                ctx.drawImage(img, centerX - (drawW/2), centerY - (drawH/2), drawW, drawH);
                const base64 = canvas.toDataURL('image/jpeg', 0.6);
                setProductForm({ ...productForm, image: base64 });
                setCropData({ ...cropData, show: false });
                setIsSavingCrop(false);
            };

            const [isDragging, setIsDragging] = useState(false);
            const [startPos, setStartPos] = useState({ x: 0, y: 0 });
            const handleMouseDown = (e) => { setIsDragging(true); setStartPos({ x: e.clientX - cropData.x, y: e.clientY - cropData.y }); };
            const handleMouseMove = (e) => { if (isDragging) setCropData({ ...cropData, x: e.clientX - startPos.x, y: e.clientY - startPos.y }); };
            const handleMouseUp = () => { setIsDragging(false); };

            const formatIDR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
            
            const formatPhoneDisplay = (phone) => {
                let p = String(phone || '').trim();
                if (!p) return '';
                return p.startsWith('0') ? p : '0' + p;
            };

            const getWALink = (phone, text) => {
                const phoneStr = formatPhoneDisplay(phone);
                const cleanPhone = phoneStr.replace(/\D/g, '');
                if (!cleanPhone) return '#';
                const apiPhone = cleanPhone.startsWith('0') ? '62' + cleanPhone.slice(1) : cleanPhone;
                return `https://wa.me/${apiPhone}?text=${encodeURIComponent(text)}`;
            };

            const handleNextToPayment = () => {
                if (buyerData.name && buyerData.phone && buyerData.school) {
                    setIsActionLoading(true);
                    setTimeout(() => { setStep('payment'); setIsActionLoading(false); }, 600);
                } else { alert("Isi semua data!"); }
            };

            const handleFinishOrder = async () => {
                if (!proofImage) return alert("Upload bukti transfer!");
                setIsActionLoading(true);
                const uniqueId = "TRX-" + Math.floor(Math.random() * 900000 + 100000);
                const payload = {
                    action: 'addOrder', id: uniqueId, productId: showModal.id,
                    productName: showModal.name, productUrl: showModal.url, price: showModal.price, 
                    method: selectedMethod, proof: proofImage,
                    buyerName: buyerData.name, buyerPhone: buyerData.phone, buyerSchool: buyerData.school,
                    status: 'pending' 
                };
                const success = await handlePost(payload);
                if(success) { setStep('success'); } else { alert("Gagal mengirim data. Cek koneksi."); }
                setIsActionLoading(false);
                fetchData();
            };

            return (
                <div className="min-h-screen pb-20 text-sm relative text-slate-800">
                    {error && (
                        <div className="bg-red-600 text-white p-4 text-center font-bold sticky top-0 z-[60] shadow-lg animate-pulse uppercase">
                           ⚠️ Koneksi Terganggu: {error}
                        </div>
                    )}

                    {appNotification && (
                        <div className="fixed top-0 left-0 w-full z-[100] p-4 slide-down">
                            <div className="bg-emerald-600 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-center gap-3 max-w-md mx-auto border-2 border-emerald-500 font-bold tracking-tight text-center uppercase">
                                <Icon name="bell" size={20} className="text-emerald-100" /> {appNotification}
                            </div>
                        </div>
                    )}

                    <nav className="bg-white border-b sticky top-0 z-20 px-6 h-16 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2 font-bold text-emerald-600 text-xl cursor-pointer select-none" onClick={handleSecretClick}>
                            <Icon name="shopping-bag" className="text-emerald-600" /> 
                            <span>LinkStore</span>
                            {view === 'admin' && <span className="text-[10px] bg-emerald-100 px-2 py-0.5 rounded-full ml-2 font-black uppercase">Mode Admin</span>}
                        </div>
                        <div className="bg-slate-100 p-1 rounded-xl flex gap-1">
                            <button onClick={() => setView('store')} className={`px-4 py-1.5 rounded-lg text-xs font-bold transition-all ${view === 'store' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}>Toko</button>
                            {view === 'admin' && (
                                <button onClick={() => setView('store')} className="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-red-50 text-red-600 shadow-sm">Keluar Admin</button>
                            )}
                        </div>
                    </nav>

                    <main className="max-w-5xl mx-auto px-4 py-8">
                        {loading && products.length === 0 && !error ? (
                            <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 px-2">
                                {[1,2,3,4,5,6].map(i => (
                                    <div key={i} className="bg-white rounded-[2.5rem] border shadow-sm h-[400px] overflow-hidden flex flex-col">
                                        <div className="h-56 w-full skeleton-shimmer"></div>
                                        <div className="p-6 space-y-4 flex-grow flex flex-col">
                                            <div className="h-6 w-3/4 skeleton-shimmer rounded-full"></div>
                                            <div className="h-4 w-1/2 skeleton-shimmer rounded-full"></div>
                                            <div className="h-12 w-full skeleton-shimmer rounded-2xl mt-auto"></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <>
                                {view === 'admin' ? (
                                    <div className="animate-in space-y-6">
                                        <div className="flex gap-4 border-b pb-1 overflow-x-auto whitespace-nowrap">
                                            <button onClick={() => setAdminTab('products')} className={`pb-4 px-2 text-sm font-bold ${adminTab === 'products' ? 'border-b-2 border-emerald-600 text-emerald-600' : 'text-slate-400'}`}>Produk</button>
                                            <button onClick={() => setAdminTab('orders')} className={`pb-4 px-2 text-sm font-bold relative ${adminTab === 'orders' ? 'border-b-2 border-emerald-600 text-emerald-600' : 'text-slate-400'}`}> Pesanan {pendingCount > 0 && <span className="ml-2 bg-red-500 text-white text-[9px] px-1.5 py-0.5 rounded-full notif-badge font-bold">{pendingCount}</span>}</button>
                                            <button onClick={() => setAdminTab('payments')} className={`pb-4 px-2 text-sm font-bold ${adminTab === 'payments' ? 'border-b-2 border-emerald-600 text-emerald-600' : 'text-slate-400'}`}>Pembayaran</button>
                                        </div>
                                        {adminTab === 'products' && (
                                            <div className="grid md:grid-cols-3 gap-8">
                                                <div className="bg-white p-6 rounded-3xl border shadow-sm h-fit space-y-4 sticky top-20">
                                                    <h3 className="font-bold text-xs uppercase text-slate-400 tracking-widest font-black">{isEditing ? 'Edit Produk' : 'Tambah Baru'}</h3>
                                                    <div onClick={() => document.getElementById('prodImg').click()} className="relative aspect-square border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-400 transition-all overflow-hidden">
                                                        <input type="file" id="prodImg" className="hidden" accept="image/*" onChange={(e) => {
                                                            const file = e.target.files[0];
                                                            if (file) {
                                                                const reader = new FileReader();
                                                                reader.onload = () => setCropData({ ...cropData, src: reader.result, show: true, scale: 1, x: 0, y: 0 });
                                                                reader.readAsDataURL(file);
                                                            }
                                                        }} />
                                                        {productForm.image ? <img src={productForm.image} className="w-full h-full object-cover" /> : <div className="text-center text-slate-400"><Icon name="image" size={32} className="mx-auto opacity-30" /><p className="text-[10px] font-bold uppercase tracking-widest font-black">Foto Sampul</p></div>}
                                                    </div>
                                                    <input className="w-full p-3 bg-slate-50 border rounded-xl text-sm font-medium" placeholder="Nama Produk" value={productForm.name || ''} onChange={e => setProductForm({...productForm, name: e.target.value})} />
                                                    <input className="w-full p-3 bg-slate-50 border rounded-xl text-sm font-medium" placeholder="URL Link" value={productForm.url || ''} onChange={e => setProductForm({...productForm, url: e.target.value})} />
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <input className="w-full p-3 bg-slate-50 border rounded-xl text-sm font-medium" type="number" placeholder="Harga" value={productForm.price || ''} onChange={e => setProductForm({...productForm, price: e.target.value})} />
                                                        <input className="w-full p-3 bg-slate-50 border rounded-xl text-sm font-medium" type="number" placeholder="Stok" value={productForm.stock || ''} onChange={e => setProductForm({...productForm, stock: e.target.value})} />
                                                    </div>
                                                    <button onClick={saveProduct} className={`w-full py-3 text-white font-bold rounded-xl shadow-lg text-xs uppercase font-black transition-all ${isEditing ? 'bg-amber-500 hover:bg-amber-600' : 'bg-emerald-600 hover:bg-emerald-700'}`}>{isEditing ? 'Perbarui Produk' : 'Simpan Produk'}</button>
                                                    {isEditing && <button onClick={() => { setProductForm({ id: '', name: '', url: '', price: '', stock: '', image: '' }); setIsEditing(false); }} className="w-full py-2 text-slate-400 font-bold text-xs uppercase underline text-center font-black">Batal Edit</button>}
                                                </div>
                                                <div className="md:col-span-2 space-y-3">
                                                    {products.length === 0 ? <p className="text-center py-20 text-slate-400 font-medium italic">Belum ada produk.</p> : products.map((p, i) => (
                                                        <div key={i} className="bg-white p-4 rounded-2xl border flex justify-between items-center group shadow-sm transition-all hover:border-emerald-200">
                                                            <div className="flex items-center gap-4">
                                                                <img src={p.image || 'https://placehold.co/400x400?text=Link'} className="w-14 h-14 object-cover rounded-xl border bg-slate-100" />
                                                                <div><p className="font-bold text-slate-700">{p.name}</p><div className="flex gap-2 items-center mt-0.5"><span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase ${Number(p.stock) <= 0 ? 'bg-red-50 text-red-500' : 'bg-slate-100 text-slate-500'}`}>Stok: {p.stock}</span><span className="text-[10px] text-emerald-600 font-bold">{formatIDR(p.price)}</span></div></div>
                                                            </div>
                                                            <div className="flex gap-1">
                                                                <button onClick={() => startEditProduct(p)} className="text-amber-500 p-2 hover:bg-amber-50 rounded-lg transition-colors"><Icon name="edit-3" size={18}/></button>
                                                                <button onClick={() => setDeleteTarget(p)} className="text-red-400 p-2 hover:bg-red-50 rounded-lg transition-colors"><Icon name="trash-2" size={18}/></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        {adminTab === 'orders' && (
                                            <div className="space-y-4">
                                                {orders.length === 0 ? <p className="text-center py-20 text-slate-400 italic font-bold text-center">Belum ada pesanan masuk.</p> : [...orders].reverse().map((o, i) => (
                                                    <div key={i} className={`bg-white p-5 rounded-3xl border shadow-sm flex flex-col md:flex-row gap-6 transition-all ${String(o.status).toLowerCase() === 'pending' ? 'border-amber-300 ring-1 ring-amber-50 shadow-lg shadow-amber-50' : 'hover:border-emerald-200'}`}>
                                                        <img src={o.proof} className="w-24 h-32 object-cover rounded-2xl border bg-slate-100 flex-shrink-0 cursor-zoom-in" onClick={() => window.open(o.proof)} />
                                                        <div className="flex-grow space-y-3">
                                                            <div className="flex justify-between items-start">
                                                                <div className="flex items-center gap-2">
                                                                    <p className="font-bold text-lg text-slate-800">{o.productName}</p>
                                                                    {String(o.status).toLowerCase() === 'pending' && <span className="bg-amber-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded animate-pulse uppercase">Baru</span>}
                                                                </div>
                                                                <span className={`status-badge ${String(o.status).toLowerCase() === 'berhasil' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}`}>{o.status || 'pending'}</span>
                                                            </div>
                                                            <div className="text-[10px] space-y-1.5 bg-slate-50 p-4 rounded-2xl border">
                                                                <p className="flex justify-between"><span>PEMBELI:</span> <b className="text-slate-800 font-bold">{o.buyerName}</b></p>
                                                                <p className="flex justify-between"><span>WHATSAPP:</span> <b className="text-slate-800 font-bold">{formatPhoneDisplay(o.buyerPhone)}</b></p>
                                                            </div>
                                                            <button onClick={async () => {
                                                                await handlePost({ action: 'updateOrderStatus', id: o.id, status: 'Berhasil' });
                                                                window.open(getWALink(o.buyerPhone, `Halo ${o.buyerName},\n\nTerima kasih. Berikut link *${o.productName}* Anda: ${o.productUrl}`), '_blank');
                                                                fetchData();
                                                            }} className={`inline-flex items-center justify-center gap-2 px-6 py-2.5 rounded-xl font-bold text-xs shadow-sm transition-all ${String(o.status).toLowerCase() === 'berhasil' ? 'bg-slate-100 text-slate-400' : 'bg-emerald-600 text-white hover:bg-emerald-700'}`}><Icon name="send" size={14} className="text-white" /> {String(o.status).toLowerCase() === 'berhasil' ? 'Kirim Ulang Link' : 'Kirim Link & Selesaikan'}</button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {adminTab === 'payments' && (
                                            <div className="max-w-3xl mx-auto space-y-6">
                                                <div className="bg-white p-6 rounded-3xl border shadow-sm space-y-6">
                                                    <h3 className="font-bold text-slate-800 underline underline-offset-4 decoration-emerald-500 font-black uppercase">Pengaturan Pembayaran</h3>
                                                    <div className="p-5 bg-slate-50 rounded-2xl border space-y-4">
                                                        <div className="flex justify-between items-center"><h4 className="font-bold text-xs uppercase text-slate-500 font-black">Transfer Bank</h4><input type="checkbox" checked={paymentConfig.isBankActive} onChange={e => setPaymentConfig({...paymentConfig, isBankActive: e.target.checked})} className="w-5 h-5 accent-emerald-500" /></div>
                                                        <div className="grid sm:grid-cols-2 gap-4">
                                                            <input className="p-3 bg-white border rounded-xl text-sm font-medium" placeholder="Nama Bank" value={paymentConfig.bankName || ''} onChange={e => setPaymentConfig({...paymentConfig, bankName: e.target.value})} />
                                                            <input className="p-3 bg-white border rounded-xl text-sm font-medium" placeholder="Nomor Rekening" value={paymentConfig.bankAccount || ''} onChange={e => setPaymentConfig({...paymentConfig, bankAccount: e.target.value})} />
                                                        </div>
                                                        <input className="w-full p-3 bg-white border rounded-xl text-sm font-medium" placeholder="Nama Pemilik" value={paymentConfig.bankHolder || ''} onChange={e => setPaymentConfig({...paymentConfig, bankHolder: e.target.value})} />
                                                    </div>
                                                    <div className="p-5 bg-slate-50 rounded-2xl border space-y-4">
                                                        <div className="flex justify-between items-center"><h4 className="font-bold text-xs uppercase text-slate-500 font-black">QRIS Barcode</h4><input type="checkbox" checked={paymentConfig.isQrisActive} onChange={e => setPaymentConfig({...paymentConfig, isQrisActive: e.target.checked})} className="w-5 h-5 accent-emerald-500" /></div>
                                                        <input className="w-full p-3 bg-white border rounded-xl text-sm font-medium" placeholder="URL Gambar QRIS" value={paymentConfig.qrisUrl || ''} onChange={e => setPaymentConfig({...paymentConfig, qrisUrl: e.target.value})} />
                                                        <textarea className="w-full p-3 bg-white border rounded-xl text-sm h-20 font-medium" placeholder="Catatan QRIS" value={paymentConfig.qrisNotes || ''} onChange={e => setPaymentConfig({...paymentConfig, qrisNotes: e.target.value})} />
                                                    </div>
                                                    <div className="p-5 bg-slate-50 rounded-2xl border space-y-4">
                                                        <div className="flex justify-between items-center"><h4 className="font-bold text-xs uppercase text-slate-500 font-black">E-Wallet (DANA)</h4><input type="checkbox" checked={paymentConfig.isDanaActive} onChange={e => setPaymentConfig({...paymentConfig, isDanaActive: e.target.checked})} className="w-5 h-5 accent-emerald-500" /></div>
                                                        <div className="grid sm:grid-cols-2 gap-4">
                                                            <input className="p-3 bg-white border rounded-xl text-sm font-medium" placeholder="Nomor DANA" value={paymentConfig.danaNumber || ''} onChange={e => setPaymentConfig({...paymentConfig, danaNumber: e.target.value})} />
                                                            <input className="p-3 bg-white border rounded-xl text-sm font-medium" placeholder="Nama Akun DANA" value={paymentConfig.danaHolder || ''} onChange={e => setPaymentConfig({...paymentConfig, danaHolder: e.target.value})} />
                                                        </div>
                                                    </div>
                                                    <button onClick={savePaymentConfig} className="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-xl hover:bg-black uppercase text-xs tracking-widest font-black transition-all">Simpan Perubahan</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 px-2 animate-in">
                                        {products.filter(p => Number(p.stock) > 0).map((p, i) => (
                                            <div key={i} className="bg-white rounded-[2.5rem] border shadow-sm flex flex-col group hover:shadow-2xl transition-all duration-500 overflow-hidden">
                                                <div className="h-56 w-full bg-slate-100 relative overflow-hidden">
                                                    {p.image ? <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition-all duration-700" /> : <div className="w-full h-full flex items-center justify-center text-emerald-600/10"><Icon name="link" size={80} /></div>}
                                                    <div className="absolute top-4 left-4 bg-emerald-500 text-white px-3 py-1 rounded-full font-black text-xs shadow-lg">{formatIDR(p.price)}</div>
                                                    <div className="absolute bottom-4 right-4 bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded-lg text-[9px] font-bold uppercase text-slate-600 tracking-widest font-black">Stok: {p.stock}</div>
                                                </div>
                                                <div className="p-6 flex flex-col flex-grow">
                                                    <h3 className="text-xl font-bold mb-8 flex-grow leading-tight text-slate-800">{p.name}</h3>
                                                    <button onClick={() => { setShowModal(p); setStep('form'); setProofImage(null); }} className="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl shadow-lg hover:bg-black transition-all uppercase text-[11px] tracking-widest font-black">Beli Sekarang</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </>
                        )}
                    </main>

                    {deleteTarget && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in zoom-in">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl border-2">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Icon name="trash-2" size={32} /></div>
                                <div><h3 className="text-xl font-bold text-slate-800">Hapus Produk?</h3><p className="text-slate-500 text-sm mt-2">Menghapus <b className="text-slate-700">{deleteTarget.name}</b> secara permanen.</p></div>
                                <div className="flex gap-3 pt-6">
                                    <button onClick={() => setDeleteTarget(null)} className="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-2xl text-xs uppercase font-black">Batal</button>
                                    <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-2xl shadow-lg shadow-red-200 text-xs uppercase tracking-wider font-black">Ya, Hapus</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {cropData.show && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-md">
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] p-8 space-y-6 animate-in zoom-in shadow-2xl border-4 border-slate-800">
                                <div className="text-center"><h3 className="text-2xl font-bold text-slate-800 font-black">Atur Foto Produk</h3><p className="text-xs text-slate-400 mt-1 uppercase font-bold tracking-widest">Geser dan perbesar gambar</p></div>
                                <div className="crop-container border-4 border-slate-100" onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                                    <img ref={cropImgRef} src={cropData.src} className="absolute max-w-none pointer-events-none" style={{ transform: `translate(calc(-50% + ${cropData.x}px), calc(-50% + ${cropData.y}px)) scale(${cropData.scale})`, top: '50%', left: '50%' }} />
                                    <div className="crop-overlay"></div>
                                </div>
                                <div className="space-y-4">
                                    <div className="flex items-center gap-4"><Icon name="minus" size={16} /><input type="range" className="flex-grow accent-emerald-500 h-1.5" min="0.1" max="3" step="0.01" value={cropData.scale} onChange={(e) => setCropData({ ...cropData, scale: Number(e.target.value) })} /><Icon name="plus" size={16} /></div>
                                    <button onClick={handleCropSave} className="w-full py-4 bg-emerald-600 text-white font-bold rounded-2xl shadow-xl uppercase text-xs tracking-widest font-black">Simpan Foto</button>
                                    <button onClick={() => setCropData({ ...cropData, show: false })} className="w-full text-slate-400 font-bold text-[10px] uppercase underline text-center font-black">Batal</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-md animate-in">
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] p-8 relative shadow-2xl overflow-hidden border-t-8 border-emerald-500">
                                {step !== 'success' && (<button onClick={() => setShowModal(null)} className="absolute right-8 top-8 text-slate-400 p-2 hover:bg-slate-50 rounded-full transition-all"><Icon name="x"/></button>)}
                                {step === 'form' && (
                                    <div className="space-y-6">
                                        <h3 className="text-3xl font-black italic text-emerald-600 uppercase underline tracking-tighter">Checkout</h3>
                                        <div className="space-y-4">
                                            <input className="w-full p-4 bg-slate-50 border rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Nama Lengkap" value={buyerData.name} onChange={e => setBuyerData({...buyerData, name: e.target.value})} />
                                            <input className="w-full p-4 bg-slate-50 border rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" placeholder="WhatsApp (0812...)" value={buyerData.phone} onChange={e => setBuyerData({...buyerData, phone: e.target.value})} />
                                            <input className="w-full p-4 bg-slate-50 border rounded-2xl text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Sekolah / Instansi" value={buyerData.school} onChange={e => setBuyerData({...buyerData, school: e.target.value})} />
                                        </div>
                                        <button onClick={handleNextToPayment} className={`w-full py-4 bg-emerald-600 text-white font-bold rounded-2xl shadow-xl text-xs uppercase tracking-widest hover:bg-emerald-700 transition-all font-black flex items-center justify-center gap-2 ${isActionLoading ? 'btn-loading' : ''}`}>
                                            {isActionLoading ? <div className="spinner-small"></div> : null}
                                            {isActionLoading ? 'MEMPROSES...' : 'Lanjut ke Pembayaran'}
                                        </button>
                                    </div>
                                )}
                                {step === 'payment' && (
                                    <div className="space-y-6 text-center">
                                        <h3 className="text-2xl font-bold uppercase italic tracking-tight font-black">Pilih Metode</h3>
                                        <div className="space-y-3 text-left">
                                            {paymentConfig.isQrisActive && <button onClick={() => { setSelectedMethod('QRIS'); setStep('detail'); }} className="w-full p-5 border-2 rounded-2xl flex items-center gap-4 hover:border-emerald-600 font-bold uppercase text-xs transition-all font-black"><Icon name="qr-code" size={24}/> Scan QRIS</button>}
                                            {paymentConfig.isBankActive && <button onClick={() => { setSelectedMethod('BANK'); setStep('detail'); }} className="w-full p-5 border-2 rounded-2xl flex items-center gap-4 hover:border-emerald-600 font-bold uppercase text-xs transition-all font-black"><Icon name="credit-card" size={24}/> Transfer {paymentConfig.bankName}</button>}
                                            {paymentConfig.isDanaActive && <button onClick={() => { setSelectedMethod('DANA'); setStep('detail'); }} className="w-full p-5 border-2 rounded-2xl flex items-center gap-4 hover:border-emerald-600 font-bold uppercase text-xs transition-all font-black"> <div className="w-6 h-6 flex items-center justify-center bg-sky-600 text-white rounded font-black italic">D</div> DANA E-Wallet</button>}
                                        </div>
                                    </div>
                                )}
                                {step === 'detail' && (
                                    <div className="text-center space-y-6 animate-in">
                                        <div className="bg-emerald-50 p-5 rounded-[2rem] border border-emerald-100 shadow-inner"><p className="text-xs font-bold text-emerald-500 uppercase tracking-widest mb-1 font-black">Total Tagihan</p><p className="text-4xl font-black text-emerald-600 leading-none">{formatIDR(showModal.price)}</p></div>
                                        {selectedMethod === 'QRIS' && (
                                            <div className="space-y-4">
                                                {paymentConfig.qrisUrl ? <img src={paymentConfig.qrisUrl} className="w-48 h-48 mx-auto border-4 border-slate-900 rounded-[2rem] p-2 bg-white shadow-xl" /> : <p className="text-xs text-slate-400 font-bold uppercase tracking-widest py-10 bg-slate-50 border-2 border-dashed rounded-2xl">QRIS Belum Tersedia</p>}
                                                <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wide italic leading-relaxed font-medium">{paymentConfig.qrisNotes}</p>
                                            </div>
                                        )}
                                        {selectedMethod === 'BANK' && (
                                            <div className="text-left bg-slate-50 p-6 rounded-[2rem] border shadow-inner">
                                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-black">{paymentConfig.bankName}</p>
                                                <p className="text-2xl font-mono font-bold text-slate-800 tracking-tighter font-black">{paymentConfig.bankAccount}</p>
                                                <p className="text-sm font-bold text-slate-600 mt-1 uppercase leading-tight font-black">{paymentConfig.bankHolder}</p>
                                            </div>
                                        )}
                                        {selectedMethod === 'DANA' && (
                                            <div className="text-left bg-sky-50 p-6 rounded-[2rem] border-2 border-sky-100 shadow-inner">
                                                <p className="text-[10px] font-bold text-sky-400 uppercase tracking-widest font-black">DANA Wallet</p>
                                                <p className="text-2xl font-mono font-bold text-sky-800 tracking-tighter font-black">{paymentConfig.danaNumber}</p>
                                                <p className="text-sm font-bold text-sky-600 mt-1 uppercase leading-tight font-black">{paymentConfig.danaHolder}</p>
                                            </div>
                                        )}
                                        <div className="relative border-2 border-dashed border-slate-300 rounded-2xl p-4 bg-slate-50 min-h-[120px] flex items-center justify-center cursor-pointer hover:border-emerald-500 transition-all">
                                            <input type="file" onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    setIsCompressing(true);
                                                    const reader = new FileReader();
                                                    reader.onload = (re) => {
                                                        const img = new Image();
                                                        img.onload = () => {
                                                            const canvas = document.createElement('canvas');
                                                            canvas.width = 800; canvas.height = 800;
                                                            const ctx = canvas.getContext('2d');
                                                            ctx.drawImage(img, 0, 0, 800, 800);
                                                            setProofImage(canvas.toDataURL('image/jpeg', 0.5));
                                                            setIsCompressing(false);
                                                        };
                                                        img.src = re.target.result;
                                                    };
                                                    reader.readAsDataURL(file);
                                                }
                                            }} className="absolute inset-0 opacity-0 cursor-pointer z-50 w-full h-full" accept="image/*" />
                                            {isCompressing ? <div className="spinner-small border-emerald-500 border-t-transparent mx-auto"></div> : proofImage ? <img src={proofImage} className="w-16 h-16 object-cover rounded-lg border shadow-sm mx-auto" /> : <div className="text-slate-400 flex flex-col items-center uppercase font-bold"><Icon name="upload" size={32}/><p className="text-[10px] mt-1 tracking-widest font-black uppercase">Upload Bukti Bayar</p></div>}
                                        </div>
                                        <button onClick={handleFinishOrder} disabled={!proofImage || isCompressing || isActionLoading} className={`w-full py-5 rounded-2xl font-black text-white text-xs tracking-[0.2em] shadow-xl transition-all flex items-center justify-center gap-2 ${proofImage ? 'bg-emerald-600 shadow-emerald-200 hover:bg-emerald-700' : 'bg-slate-300'} ${isActionLoading ? 'btn-loading' : ''}`}>
                                            {isActionLoading ? <div className="spinner-small"></div> : null}
                                            {isActionLoading ? 'MENGIRIM...' : 'KIRIM KONFIRMASI'}
                                        </button>
                                    </div>
                                )}
                                {step === 'success' && (
                                    <div className="text-center py-10 space-y-8 animate-in">
                                        <div className="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto shadow-2xl border-4 border-white"><Icon name="check" className="text-emerald-600" size={48}/></div>
                                        <div className="px-4"><h3 className="text-3xl font-black text-emerald-600 italic uppercase tracking-tighter text-center">Data Terkirim!</h3>
                                            <p className="text-slate-600 text-sm font-medium leading-relaxed text-center">
                                                Terima kasih, <b>{buyerData.name}</b>! Bukti pembayaran telah kami terima. <br/><br/> 
                                                Link <b className="text-black font-black">{showModal?.name}</b> yang anda beli akan segera dikirimkan ke nomor WhatsApp Anda oleh Admin kami. <br/><br/> 
                                                Mohon periksa pesan masuk Anda secara berkala.
                                            </p>
                                        </div>
                                        <button onClick={() => { setAppNotification('LINK AKAN DIKIRIM KE WHATSAPP ANDA'); setShowModal(null); setStep('form'); setTimeout(() => setAppNotification(''), 6000); }} className="block w-full py-5 bg-slate-900 text-white font-black rounded-3xl text-xs tracking-widest uppercase shadow-2xl transition-all hover:bg-black font-black text-white text-center">SELESAI</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>