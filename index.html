<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amalan Ramadhan Multi-School</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Error Handler Global
    window.onerror = function(msg, url, line, col, error) {
        const app = document.getElementById('app');
        if (app) {
            app.innerHTML = `
                <div style="padding: 20px; color: red; font-family: sans-serif; text-align: center;">
                    <h3>Terjadi Kesalahan Aplikasi</h3>
                    <p>${msg}</p>
                    <button onclick="localStorage.clear(); location.reload();" style="margin-top:10px; padding: 10px 20px; background: #333; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Reset & Reload Aplikasi
                    </button>
                </div>
            `;
        }
        return false;
    };

    window.elementSdk = {
        config: {},
        init: (options) => {
            if (options.onConfigChange) options.onConfigChange(options.defaultConfig);
        },
        setConfig: (conf) => { Object.assign(window.elementSdk.config, conf); }
    };
    window.dataSdk = {
        init: () => Promise.resolve({ isOk: true }),
        create: (data) => Promise.resolve({ isOk: true })
    };
  </script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; }
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tab-button.active { border-bottom: 3px solid; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        
        /* Animasi */
        @keyframes pulseBlue {
          0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
          70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
          100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        @keyframes pulseGreen {
          0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
          70% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
          100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .pulse-blue { animation: pulseBlue 2s infinite; }
        .pulse-green { animation: pulseGreen 2s infinite; }
    </style>
 </head>
 <body class="h-full bg-gray-50">
  <div id="app" class="w-full h-full overflow-auto"></div>
  <script>
        /**
         * KONFIGURASI SISTEM LAMA (MULTI-SCHOOL)
         */
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7IjJZdiHITMGhSMSWWneT1E9qIWUOBwkuJv4krc4_IPk-pQYA1hgFXyNfMu9oKjr6Bw/exec';
        const INFO_DRIVE_URL = 'https://drive.google.com/drive/folders/1p_MFakH19ATtDCS7zxaZ89zIAV_t6czu?usp=drive_link';
        
        // Logika ID Sekolah (Sistem Lama)
        function getSchoolId() {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            if (!id && window.location.href.includes('id=')) {
                id = window.location.href.split('id=')[1].split('&')[0];
            }
            if (!id) {
                id = sessionStorage.getItem('current_school_id');
            }
            return id;
        }

        let SCHOOL_ID = getSchoolId();

        // Helper untuk mengambil nama sekolah
        function getSchoolName() {
            if (!SCHOOL_ID) return "";
            return localStorage.getItem('school_name_' + SCHOOL_ID) || "";
        }

        const defaultConfig = {
            app_title: "Amalan Ramadhan Siswa",
            welcome_message: "Selamat datang di aplikasi Amalan Ramadhan",
            background_color: "#10b981",
            surface_color: "#ffffff",
            text_color: "#1f2937",
            primary_action_color: "#059669",
            secondary_action_color: "#6b7280",
            font_family: "Arial",
            font_size: 16
        };

        let currentUser = null;
        let currentTab = 'Shalat Fardu';
        let allRecords = [];
        let hasInfoFiles = false; 
        const categories = ['Shalat Fardu', 'Tarawih', 'Puasa', 'Tadarus', 'Ceramah'];

        let shalatData = {};
        let tarawihData = {};
        let puasaData = {};
        let tadarusData = {};
        let ceramahData = {};

        function initDefaultData() {
            for (let i = 1; i <= 30; i++) {
                shalatData[i] = { 'Subuh': null, 'Dzuhur': null, 'Ashar': null, 'Maghrib': null, 'Isya': null };
                tarawihData[i] = { status: null, tempat: null };
                puasaData[i] = null;
                tadarusData[i] = { pilihan: null, surat: '', ayat: '', ustadz: '' };
                ceramahData[i] = { penceramah: '', tempat: '', media: '', ringkasan: '' };
            }
        }
        initDefaultData();

        function safeGetStorage(key) { try { return localStorage.getItem(key); } catch (e) { return null; } }
        function safeSetStorage(key, value) { try { localStorage.setItem(key, value); } catch (e) {} }
        function safeRemoveStorage(key) { try { localStorage.removeItem(key); } catch (e) {} }
        
        function loadAllRecords() {
            const saved = safeGetStorage('ramadhanAllRecords');
            if (saved) { try { allRecords = JSON.parse(saved); } catch(e) {} }
        }
        function saveAllRecords() { safeSetStorage('ramadhanAllRecords', JSON.stringify(allRecords)); }

        function getUserStateKey() {
            if (!currentUser) return null;
            // PENTING: Gunakan 'nama' agar konsisten dengan data lama
            return `ramadhanState_${currentUser.nama.replace(/\s+/g, '_')}_${currentUser.kelas}`;
        }

        function loadUserState() {
            const key = getUserStateKey();
            if (!key) return;
            const savedState = safeGetStorage(key);
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.shalatData) shalatData = state.shalatData;
                    if (state.tarawihData) tarawihData = state.tarawihData;
                    if (state.puasaData) puasaData = state.puasaData;
                    if (state.tadarusData) tadarusData = state.tadarusData;
                    if (state.ceramahData) ceramahData = state.ceramahData;
                } catch (e) { initDefaultData(); }
            } else { initDefaultData(); }
        }

        function saveUserState() {
            const key = getUserStateKey();
            if (!key || isAdmin()) return;
            safeSetStorage(key, JSON.stringify({ shalatData, tarawihData, puasaData, tadarusData, ceramahData }));
        }

        function showToast(message, isSuccess = true) {
            const toast = document.createElement('div');
            toast.className = `toast fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white z-[100] ${isSuccess ? 'bg-green-600' : 'bg-red-600'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showConfirmDialog(message, onConfirm, isDanger = false) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4 transition-opacity duration-200';
            overlay.style.opacity = '0';
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all duration-200 scale-95';
            modal.innerHTML = `
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full ${isDanger ? 'bg-red-100' : 'bg-blue-100'} mb-4">
                        <svg class="h-6 w-6 ${isDanger ? 'text-red-600' : 'text-blue-600'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <h3 class="text-lg leading-6 font-bold text-gray-900 mb-2">Konfirmasi</h3>
                    <p class="text-sm text-gray-500 mb-6">${message}</p>
                    <div class="flex gap-3 justify-center">
                        <button class="modal-cancel-btn flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">Batal</button>
                        <button class="modal-confirm-btn flex-1 px-4 py-2 text-white rounded-lg font-medium shadow-md ${isDanger ? 'bg-red-600' : 'bg-blue-600'}">Ya, Lanjutkan</button>
                    </div>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            requestAnimationFrame(() => { overlay.style.opacity = '1'; modal.classList.add('scale-100'); });
            const close = () => { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 200); };
            overlay.querySelector('.modal-cancel-btn').onclick = close;
            overlay.querySelector('.modal-confirm-btn').onclick = () => { close(); onConfirm(); };
        }

        function handleLogout() {
            showConfirmDialog("Apakah Anda yakin ingin keluar?", () => {
                safeRemoveStorage('ramadhanUser');
                currentUser = null;
                showLoginPage();
                showToast("Berhasil keluar.");
            });
        }

        function isAdmin() { return currentUser && currentUser.nama === '*'; }

        // --- SISTEM LAMA: REGISTRASI SEKOLAH ---
        function renderRegistration() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-6 bg-emerald-600">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-black text-slate-800">Daftar Sekolah</h1>
                            <p class="text-slate-400 text-sm mt-2">Silahkan isi dengan gmail yang aktif dan Nama Sekolah.</p>
                        </div>
                        <form id="regForm" class="space-y-4">
                            <input type="email" id="regEmail" placeholder="Gmail Guru" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-emerald-500 transition-all" required>
                            <input type="text" id="regSchool" placeholder="Nama Sekolah" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl outline-none focus:border-emerald-500 transition-all" required>
                            <button type="submit" id="regBtn" class="w-full bg-emerald-600 text-white p-4 rounded-2xl font-black shadow-lg">DAFTAR</button>
                        </form>
                        <div id="regResult" class="mt-8 hidden p-6 bg-slate-900 rounded-3xl text-white">
                            <p class="text-[10px] font-bold text-emerald-400 uppercase mb-2">Link Siswa Anda:</p>
                            <textarea id="shareLink" class="w-full p-3 text-[11px] font-mono border rounded-xl bg-slate-800 border-slate-700 h-24 mb-3" readonly></textarea>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <button onclick="downloadLink()" class="py-3 bg-blue-600 text-white rounded-xl font-bold pulse-blue shadow-lg text-xs">Unduh Link</button>
                                <button onclick="copyLink()" class="py-3 bg-emerald-600 text-white rounded-xl font-bold pulse-green shadow-lg text-xs">Salin Link</button>
                            </div>
                            <button onclick="exitApp()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold shadow-lg border border-slate-600">SELESAI</button>
                        </div>
                    </div>
                </div>`;

            document.getElementById('regForm').onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('regBtn');
                const emailInput = document.getElementById('regEmail').value;
                const schoolInput = document.getElementById('regSchool').value;
                
                const localHistory = JSON.parse(localStorage.getItem('reg_history') || '[]');
                const isDuplicate = localHistory.some(item => 
                    item.email.toLowerCase() === emailInput.trim().toLowerCase() && 
                    item.school.toLowerCase() === schoolInput.trim().toLowerCase()
                );

                if (isDuplicate) {
                    showToast("Gmail dan Sekolah ini sudah digunakan!", false);
                    return;
                }

                btn.disabled = true; btn.textContent = "Memproses...";
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ 
                        action: 'registerTeacher', 
                        email: emailInput,
                        nama_sekolah: schoolInput 
                    })});
                    const data = await res.json();
                    if (data.ss_id) {
                        localHistory.push({ email: emailInput, school: schoolInput });
                        localStorage.setItem('reg_history', JSON.stringify(localHistory));
                        
                        // SIMPAN NAMA SEKOLAH DI LOCAL STORAGE
                        localStorage.setItem('school_name_' + data.ss_id, schoolInput);

                        document.getElementById('regResult').classList.remove('hidden');
                        sessionStorage.setItem('current_school_id', data.ss_id);
                        document.getElementById('shareLink').value = window.location.href.split('?')[0] + '?id=' + data.ss_id;
                        btn.textContent = "Berhasil!";
                    }
                } catch (err) { btn.disabled = false; btn.textContent = "Coba Lagi"; }
            };
        }

        window.exitApp = () => {
            try { window.close(); } catch (e) {}
            document.getElementById('app').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center bg-gray-900 text-white p-6 text-center">
                    <h1 class="text-4xl font-bold mb-4">Selesai</h1>
                    <p class="text-gray-400">Pendaftaran berhasil. Silakan tutup tab atau keluar dari aplikasi ini.</p>
                </div>
            `;
        }

        window.copyLink = () => {
            const text = document.getElementById('shareLink').value;
            const runFallback = () => {
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta); ta.select();
                try { document.execCommand('copy'); showToast("Link disalin!"); } catch (err) { showToast("Gagal menyalin otomatis.", false); }
                document.body.removeChild(ta);
            };
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => showToast("Link disalin!")).catch(() => runFallback());
            } else { runFallback(); }
        };

        window.downloadLink = () => {
            const link = document.getElementById('shareLink').value;
            // PERBAIKAN: Menghapus instruksi pilih kelas
            const textContent = `INFO AKSES APLIKASI AMALAN RAMADHAN\n-----------------------------------------\nLINK SISWA : \n${link}\n\nCARA MASUK KE PANEL GURU:\n-----------------------------------------\n1. Buka link di atas.\n2. Nama Lengkap Siswa : * (tanda bintang)\n3. Klik Masuk.\n\nGunakan Panel Guru untuk memantau rekap amalan dan mencetak laporan siswa secara otomatis.`;
            const blob = new Blob([textContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'link_dan_instruksi_guru.txt'; a.click();
            window.URL.revokeObjectURL(url);
            showToast("Link & Instruksi diunduh!");
        };

        async function syncUserFromCloud() {
            if (!currentUser || isAdmin() || !SCHOOL_ID) return;
            try {
                const url = new URL(GOOGLE_SCRIPT_URL);
                url.searchParams.append('action', 'read');
                url.searchParams.append('ss_id', SCHOOL_ID);
                url.searchParams.append('nama', currentUser.nama);
                url.searchParams.append('kelas', currentUser.kelas);
                
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    result.data.forEach(item => {
                        const tgl = item.tanggal;
                        const cat = item.kategori;
                        let detail = item.detail || item.hadir;
                        if (typeof detail === 'string') { try { detail = JSON.parse(detail); } catch(e) {} }
                        
                        if (cat === 'Shalat Fardu') shalatData[tgl] = { ...shalatData[tgl], ...detail };
                        else if (cat === 'Tarawih') tarawihData[tgl] = { ...tarawihData[tgl], ...detail };
                        else if (cat === 'Puasa') puasaData[tgl] = detail.status || detail;
                        else if (cat === 'Tadarus') tadarusData[tgl] = { ...tadarusData[tgl], ...detail };
                        else if (cat === 'Ceramah') ceramahData[tgl] = { ...ceramahData[tgl], ...detail };
                    });
                    saveUserState();
                    if (document.getElementById('contentArea')) renderContentArea();
                }
            } catch (e) {}
        }

        async function fetchAllDataForAdmin() {
            if (!SCHOOL_ID) return showToast("Error: ID Sekolah tidak ditemukan.", false);
            const loadingToast = document.createElement('div');
            loadingToast.className = `toast fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg text-white z-50 bg-indigo-600 flex items-center gap-2`;
            loadingToast.innerHTML = `<span>üîÑ</span> Sinkronisasi database...`;
            document.body.appendChild(loadingToast);
            
            try {
                const checkUrl = new URL(GOOGLE_SCRIPT_URL);
                checkUrl.searchParams.append('action', 'checkInfo');
                const checkRes = await fetch(checkUrl);
                const checkData = await checkRes.json();
                hasInfoFiles = checkData.hasFiles === true;
            } catch (e) { hasInfoFiles = true; }

            try {
                const url = new URL(GOOGLE_SCRIPT_URL);
                url.searchParams.append('action', 'readAll');
                url.searchParams.append('ss_id', SCHOOL_ID);
                const response = await fetch(url);
                const result = await response.json();
                if (result.status === 'success' && Array.isArray(result.data)) {
                    allRecords = result.data.map(item => ({
                        nama: item.nama, kelas: item.kelas, kategori: item.kategori, tanggal: item.tanggal, hadir: item.detail || item.hadir
                    }));
                    saveAllRecords();
                    if (isAdmin()) showLaporanPage();
                    showToast("Database Sinkron!");
                }
            } catch (e) { showToast("Gagal sinkronisasi.", false); }
            finally { loadingToast.remove(); }
        }

        function showLoginPage() {
            // PERBAIKAN: Menggabungkan config default dengan config yang mungkin belum ada
            const config = { ...defaultConfig, ...(window.elementSdk?.config || {}) };
            const lastNama = safeGetStorage('last_nama') || '';
            const lastKelas = safeGetStorage('last_kelas') || '';
            const schoolName = getSchoolName();

            let classOptions = `<option value="">Pilih Kelas</option>`;
            ['7','8','9'].forEach(g => {
                classOptions += `<optgroup label="Kelas ${g}">`;
                ['A','B','C','D','E','F','G','H','I','J'].forEach(s => {
                    const c = `${g}${s}`;
                    classOptions += `<option value="${c}" ${c === lastNama ? 'selected' : ''}>${c}</option>`;
                });
                classOptions += `</optgroup>`;
            });
            document.getElementById('app').innerHTML = `
                <div class="w-full h-full flex items-center justify-center p-4" style="background: ${config.background_color};">
                    <div class="w-full max-w-md rounded-2xl shadow-2xl p-8 bg-white">
                        <h1 class="text-center font-bold text-3xl mb-2 text-emerald-700">
                            ${config.app_title}
                            ${schoolName ? '<br><span class="text-lg text-emerald-600">' + schoolName + '</span>' : ''}
                        </h1>
                        <p class="text-center text-sm mb-8 text-gray-500">${config.welcome_message}</p>
                        <form id="loginForm" class="space-y-4">
                            <div><label class="block mb-1 font-semibold text-gray-700">Nama Lengkap Siswa</label><input type="text" id="nama" value="${lastNama}" class="w-full px-4 py-2 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500"></div>
                            <div><label class="block mb-1 font-semibold text-gray-700">Kelas</label><select id="kelas" class="w-full px-4 py-2 border rounded-xl bg-white outline-none focus:ring-2 focus:ring-emerald-500">${classOptions}</select></div>
                            <button type="submit" class="w-full py-3 rounded-xl text-white font-bold bg-emerald-600 hover:bg-emerald-700 transition-all shadow-lg active:scale-95">Masuk Sekarang</button>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const nama = document.getElementById('nama').value.trim();
                const kelas = document.getElementById('kelas').value.trim();
                const admin = nama === '*';
                if (!admin && (!nama || !kelas)) return showToast("Mohon isi nama dan kelas", false);
                
                if (!admin) { safeSetStorage('last_nama', nama); safeSetStorage('last_kelas', kelas); }
                
                currentUser = { nama: nama, kelas: admin ? '*' : kelas, password: admin ? '*' : '' };
                safeSetStorage('ramadhanUser', JSON.stringify(currentUser));
                loadUserState();
                if (!admin) syncUserFromCloud();
                showAmalanPage();
            });
        }

        function showAmalanPage() {
            if (!currentUser) return showLoginPage();
            if (isAdmin()) return (showLaporanPage(), fetchAllDataForAdmin());
            // PERBAIKAN: Menggabungkan config default dengan config yang mungkin belum ada
            const config = { ...defaultConfig, ...(window.elementSdk?.config || {}) };
            const schoolName = getSchoolName();

            document.getElementById('app').innerHTML = `
                <div class="w-full h-full overflow-auto" style="background: ${config.background_color};">
                    <div class="max-w-4xl mx-auto p-4 md:p-6 pb-24">
                        <div class="rounded-2xl shadow-xl p-6 mb-6 bg-white">
                            <h1 class="font-bold text-2xl mb-4 text-emerald-800">
                                ${config.app_title}
                                ${schoolName ? '<span class="block text-lg font-medium text-emerald-600">' + schoolName + '</span>' : ''}
                            </h1>
                            <div class="mb-6 bg-emerald-50 p-4 rounded-xl text-sm border border-emerald-100">
                                <p class="mb-1 text-emerald-900"><strong>üë§ Nama:</strong> ${currentUser.nama}</p>
                                <p class="text-emerald-900"><strong>üè´ Kelas:</strong> ${currentUser.kelas}</p>
                            </div>
                            <div class="flex flex-wrap gap-3">
                                <button id="rekapBtn" class="flex-1 px-4 py-2.5 rounded-xl text-white bg-emerald-600 hover:bg-emerald-700 shadow-md font-bold flex items-center justify-center gap-2">üìä Rekap Saya</button>
                                <button id="logoutBtn" class="px-4 py-2.5 rounded-xl text-white bg-red-500 hover:bg-red-600 shadow-md font-bold">Keluar</button>
                            </div>
                        </div>
                        <div class="rounded-xl shadow-lg mb-6 overflow-hidden sticky top-0 z-40 bg-white border">
                            <div class="flex overflow-x-auto no-scrollbar">
                                ${categories.map(cat => `<button class="tab-button flex-1 px-4 py-4 font-bold whitespace-nowrap text-sm ${currentTab === cat ? 'active text-emerald-600 border-b-4 border-emerald-600 bg-emerald-50/50' : 'text-gray-500'}" data-tab="${cat}">${cat}</button>`).join('')}
                            </div>
                        </div>
                        <div class="rounded-2xl shadow-xl p-6 bg-white min-h-[500px]">
                            <h2 class="font-bold text-xl mb-6 flex items-center gap-2 text-gray-800 border-b pb-2"><span>üìù</span> Isi Data: ${currentTab}</h2>
                            <div id="contentArea"></div>
                        </div>
                    </div>
                </div>
            `;
            document.querySelectorAll('.tab-button').forEach(btn => btn.onclick = (e) => { currentTab = e.target.dataset.tab; showAmalanPage(); });
            document.getElementById('rekapBtn').onclick = showRekapPage;
            document.getElementById('logoutBtn').onclick = handleLogout;
            renderContentArea();
        }

        function renderContentArea() {
            const area = document.getElementById('contentArea');
            const days = Array.from({length: 30}, (_, i) => i + 1);
            
            if (currentTab === 'Shalat Fardu') {
                area.innerHTML = `<div class="space-y-8">${days.map(t => `
                    <div class="p-5 border rounded-2xl bg-white shadow-sm border-l-8 border-emerald-500">
                        <h3 class="font-black text-emerald-800 mb-4 flex justify-between">üìÖ Hari ke-${t} <span class="text-xs font-normal text-gray-400 italic">Shalat Wajib</span></h3>
                        <div class="space-y-4">
                            ${['Subuh','Dzuhur','Ashar','Maghrib','Isya'].map(w => `
                                <div class="flex flex-col md:flex-row md:items-center gap-3 pb-3 border-b border-gray-100 last:border-0">
                                    <div class="w-24 font-bold text-gray-600">‚è∞ ${w}</div>
                                    <div class="flex flex-wrap gap-2 flex-1">
                                        ${['berjamaah','munfarid','haid','tidak shalat'].map(s => `
                                            <button class="sh-btn px-3 py-1.5 text-xs rounded-full border-2 transition-all font-semibold ${shalatData[t]?.[w] === s ? 'bg-emerald-600 text-white border-emerald-600 scale-105' : 'bg-white text-gray-500 border-gray-100'}" data-t="${t}" data-w="${w}" data-s="${s}">${s}</button>
                                        `).join('')}
                                    </div>
                                    <button class="sv-wkt-btn px-3 py-1.5 text-xs rounded-lg bg-blue-600 text-white font-bold shadow hover:bg-blue-700 active:scale-95" data-t="${t}" data-w="${w}">üíæ Simpan ${w}</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`).join('')}</div>`;
                area.querySelectorAll('.sh-btn').forEach(b => b.onclick = (e) => { const d = e.target.dataset; shalatData[d.t][d.w] = d.s; saveUserState(); renderContentArea(); });
                area.querySelectorAll('.sv-wkt-btn').forEach(b => b.onclick = (e) => handleSimpanPerWaktu(e.target.dataset.t, e.target.dataset.w));
            } else if (currentTab === 'Tarawih') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-5 border rounded-2xl shadow-sm border-l-8 border-indigo-500"><h3 class="font-black text-indigo-900 mb-4">üìÖ Hari ke-${t}</h3><div class="mb-4"><p class="text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">STATUS PELAKSANAAN</p><div class="flex flex-wrap gap-2">${['berjamaah','munfarid','tidak mengerjakan','sakit','haid'].map(s => `<button class="tr-s px-3 py-2 text-xs border-2 rounded-xl font-bold ${tarawihData[t]?.status === s ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white border-gray-100'}" data-t="${t}" data-s="${s}">${s}</button>`).join('')}</div></div><div class="mb-4"><p class="text-[10px] font-black text-gray-400 mb-2 uppercase tracking-widest">TEMPAT</p><div class="flex gap-2">${['mesjid','rumah'].map(tmp => `<button class="tr-t px-4 py-2 text-xs border-2 rounded-xl font-bold ${tarawihData[t]?.tempat === tmp ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white border-gray-100'}" data-t="${t}" data-tmp="${tmp}">${tmp}</button>`).join('')}</div></div><button class="sv-harian w-full py-3 bg-indigo-600 text-white rounded-xl font-black shadow-lg" data-t="${t}">üíæ SIMPAN DATA TARAWIH</button></div>`).join('')}</div>`;
                area.querySelectorAll('.tr-s').forEach(b => b.onclick = (e) => { tarawihData[e.target.dataset.t].status = e.target.dataset.s; saveUserState(); renderContentArea(); });
                area.querySelectorAll('.tr-t').forEach(b => b.onclick = (e) => { tarawihData[e.target.dataset.t].tempat = e.target.dataset.tmp; saveUserState(); renderContentArea(); });
                area.querySelectorAll('.sv-harian').forEach(b => b.onclick = (e) => handleSimpanHarian(e.target.dataset.t));
            } else if (currentTab === 'Puasa') {
                area.innerHTML = `<div class="space-y-4">${days.map(t => `<div class="p-5 border rounded-2xl border-l-8 border-orange-500 shadow-sm"><h3 class="font-black text-orange-900 mb-4">üìÖ Hari ke-${t}</h3><div class="flex flex-wrap gap-2 mb-4">${['mengerjakan','tidak mengerjakan','sakit','haid'].map(s => `<button class="ps-s px-4 py-2 text-xs border-2 rounded-xl font-bold ${puasaData[t] === s ? 'bg-orange-500 text-white border-orange-500' : 'bg-white border-gray-100'}" data-t="${t}" data-s="${s}">${s}</button>`).join('')}</div><button class="sv-harian w-full py-3 bg-orange-500 text-white rounded-xl font-black shadow-lg" data-t="${t}">üíæ SIMPAN DATA PUASA</button></div>`).join('')}</div>`;
                area.querySelectorAll('.ps-s').forEach(b => b.onclick = (e) => { puasaData[e.target.dataset.t] = e.target.dataset.s; saveUserState(); renderContentArea(); });
                area.querySelectorAll('.sv-harian').forEach(b => b.onclick = (e) => handleSimpanHarian(e.target.dataset.t));
            } else if (currentTab === 'Tadarus') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-5 border rounded-2xl border-l-8 border-blue-500 shadow-sm"><h3 class="font-black text-blue-900 mb-4">üìÖ Hari ke-${t}</h3><div class="flex gap-2 mb-4">${['sendiri','ustadz'].map(m => `<button class="td-m px-4 py-2 text-xs border-2 rounded-xl font-bold ${tadarusData[t]?.pilihan === m ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-100'}" data-t="${t}" data-m="${m}">${m === 'sendiri' ? 'Sendiri' : 'Simakan Bersama Ustadz'}</button>`).join('')}</div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-[10px] font-black text-gray-400">NAMA SURAT</label><input type="text" class="td-s w-full p-3 border-2 border-gray-50 rounded-xl text-sm outline-none focus:border-blue-500" placeholder="QS. Al Fatihah" data-t="${t}" value="${tadarusData[t]?.surat || ''}"></div><div><label class="text-[10px] font-black text-gray-400">AYAT</label><input type="text" class="td-a w-full p-3 border-2 border-gray-50 rounded-xl text-sm outline-none focus:border-blue-500" placeholder="1-7" data-t="${t}" value="${tadarusData[t]?.ayat || ''}"></div></div><button class="sv-harian w-full py-3 bg-blue-600 text-white rounded-xl font-black shadow-lg" data-t="${t}">üíæ SIMPAN TADARUS</button></div>`).join('')}</div>`;
                area.querySelectorAll('.td-m').forEach(b => b.onclick = (e) => { tadarusData[e.target.dataset.t].pilihan = e.target.dataset.m; saveUserState(); renderContentArea(); });
                area.querySelectorAll('.td-s').forEach(i => i.oninput = (e) => { tadarusData[e.target.dataset.t].surat = e.target.value; saveUserState(); });
                area.querySelectorAll('.td-a').forEach(i => i.oninput = (e) => { tadarusData[e.target.dataset.t].ayat = e.target.value; saveUserState(); });
                area.querySelectorAll('.sv-harian').forEach(b => b.onclick = (e) => handleSimpanHarian(e.target.dataset.t));
            } else if (currentTab === 'Ceramah') {
                area.innerHTML = `<div class="space-y-6">${days.map(t => `<div class="p-5 border rounded-2xl border-l-8 border-rose-500 shadow-sm"><h3 class="font-black text-rose-900 mb-4">üìÖ Hari ke-${t}</h3><div class="space-y-3"><input type="text" class="cr-p w-full p-3 border-2 border-gray-50 rounded-xl text-sm outline-none focus:border-rose-500" placeholder="Nama Penceramah" data-t="${t}" value="${ceramahData[t]?.penceramah || ''}"><input type="text" class="cr-t w-full p-3 border-2 border-gray-50 rounded-xl text-sm outline-none focus:border-rose-500" placeholder="Tempat / Media" data-t="${t}" value="${ceramahData[t]?.tempat || ''}"><textarea class="cr-r w-full p-3 border-2 border-gray-50 rounded-xl text-sm outline-none focus:border-rose-500" placeholder="Ringkasan isi ceramah..." data-t="${t}">${ceramahData[t]?.ringkasan || ''}</textarea></div><button class="sv-harian w-full mt-4 py-3 bg-rose-600 text-white rounded-xl font-black shadow-lg" data-t="${t}">üíæ SIMPAN CERAMAH</button></div>`).join('')}</div>`;
                area.querySelectorAll('.cr-p').forEach(i => i.oninput = (e) => { ceramahData[e.target.dataset.t].penceramah = e.target.value; saveUserState(); });
                area.querySelectorAll('.cr-t').forEach(i => i.oninput = (e) => { ceramahData[e.target.dataset.t].tempat = e.target.value; saveUserState(); });
                area.querySelectorAll('.cr-r').forEach(i => i.oninput = (e) => { ceramahData[e.target.dataset.t].ringkasan = e.target.value; saveUserState(); });
                area.querySelectorAll('.sv-harian').forEach(b => b.onclick = (e) => handleSimpanHarian(e.target.dataset.t));
            }
        }

        async function handleSimpanPerWaktu(tgl, wkt) {
            if (!SCHOOL_ID) return showToast("Error: ID Sekolah tidak ditemukan.", false);
            const status = shalatData[tgl]?.[wkt];
            if (!status) return showToast(`Sila pilih status untuk shalat ${wkt} terlebih dahulu!`, false);
            const btn = document.querySelector(`.sv-wkt-btn[data-t="${tgl}"][data-w="${wkt}"]`);
            if (btn) { btn.disabled = true; btn.textContent = '...'; }
            
            const record = { nama: currentUser.nama, kelas: currentUser.kelas, kategori: 'Shalat Fardu', tanggal: tgl, hadir: JSON.stringify(shalatData[tgl]) };
            allRecords = allRecords.filter(r => !(r.nama === currentUser.nama && r.kelas === currentUser.kelas && r.kategori === 'Shalat Fardu' && r.tanggal == tgl));
            allRecords.push(record); 
            saveAllRecords();

            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ ss_id: SCHOOL_ID, ...record, sheet: 'Shalat Fardu', shalat_detail: shalatData[tgl] }) });
                showToast(`Data ${wkt} Hari ke-${tgl} disimpan!`);
            } catch (e) { showToast("Gagal mengirim data.", false); }
            finally { if (btn) { btn.disabled = false; btn.textContent = `üíæ Simpan ${wkt}`; } }
        }

        async function handleSimpanHarian(tgl) {
            if (!SCHOOL_ID) return showToast("Error: ID Sekolah tidak ditemukan.", false);
            
            if (currentTab === 'Tarawih') {
                const d = tarawihData[tgl]; if (!d || !d.status || !d.tempat) return showToast("Sila pilih Status dan Tempat!", false);
            } else if (currentTab === 'Puasa') {
                if (!puasaData[tgl]) return showToast("Sila pilih Status Puasa!", false);
            } else if (currentTab === 'Tadarus') {
                const d = tadarusData[tgl]; if (!d || !d.pilihan || !d.surat.trim() || !d.ayat.trim()) return showToast("Sila lengkapi data Tadarus!", false);
            } else if (currentTab === 'Ceramah') {
                const d = ceramahData[tgl]; if (!d || !d.penceramah.trim() || !d.tempat.trim() || !d.ringkasan.trim()) return showToast("Sila lengkapi data Ceramah!", false);
            }
            const btn = document.querySelector(`.sv-harian[data-t="${tgl}"]`);
            if (btn) { btn.disabled = true; btn.textContent = 'SEDANG MENGIRIM...'; }
            let detail = "";
            if (currentTab === 'Shalat Fardu') detail = JSON.stringify(shalatData[tgl]);
            else if (currentTab === 'Tarawih') detail = JSON.stringify(tarawihData[tgl]);
            else if (currentTab === 'Puasa') detail = JSON.stringify(puasaData[tgl]);
            else if (currentTab === 'Tadarus') detail = JSON.stringify(tadarusData[tgl]);
            else if (currentTab === 'Ceramah') detail = JSON.stringify(ceramahData[tgl]);
            
            const record = { nama: currentUser.nama, kelas: currentUser.kelas, kategori: currentTab, tanggal: tgl, hadir: detail };
            
            allRecords = allRecords.filter(r => !(r.nama === currentUser.nama && r.kelas === currentUser.kelas && r.kategori === currentTab && r.tanggal == tgl));
            allRecords.push(record);
            saveAllRecords();

            try {
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify({ ss_id: SCHOOL_ID, ...record, sheet: currentTab, shalat_detail: shalatData[tgl], tarawih_detail: tarawihData[tgl], puasa_detail: puasaData[tgl], tadarus_detail: tadarusData[tgl], ceramah_detail: ceramahData[tgl] }) });
                showToast(`Data Hari ke-${tgl} berhasil dikirim!`);
            } catch (e) { showToast("Gagal terhubung ke Cloud.", false); }
            finally { if (btn) { btn.disabled = false; btn.textContent = `üíæ SIMPAN DATA ${currentTab.toUpperCase()}`; } }
        }

        function getMergedRecords(records) {
            const map = new Map();
            records.forEach(r => {
                const key = `${r.nama}-${r.kelas}-${r.kategori}-${r.tanggal}`;
                map.set(key, r); 
            });
            return Array.from(map.values());
        }

        function showRekapPage() {
            const myRaw = allRecords.filter(r => r.nama === currentUser.nama && r.kelas === currentUser.kelas);
            const my = getMergedRecords(myRaw);

            document.getElementById('app').innerHTML = `<div class="w-full h-full overflow-auto bg-gray-50 p-4 md:p-8"><div class="max-w-4xl mx-auto"><div class="bg-white p-6 rounded-2xl shadow-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div><h1 class="font-black text-3xl text-emerald-800">üìä Rekap Amalan Saya</h1><p class="text-gray-500">Ringkasan data terbaru untuk setiap harinya.</p></div><button id="backBtn" class="px-6 py-3 bg-emerald-600 text-white font-black rounded-xl shadow-lg active:scale-95">‚Üê KEMBALI MENGISI</button></div><div class="space-y-8">${categories.map(cat => { const items = my.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal)); return `<div class="bg-white rounded-2xl shadow-md overflow-hidden border"><div class="p-4 bg-emerald-50 border-b flex justify-between items-center"><span class="font-black text-emerald-800">${getCategoryIcon(cat)} ${cat}</span><span class="bg-white px-3 py-1 rounded-full text-xs font-bold text-emerald-600">${items.length} HARI</span></div><div class="divide-y">${items.length ? items.map(r => `<div class="p-4 flex gap-4 text-sm"><span class="font-black text-gray-300 whitespace-nowrap">HARI ${r.tanggal}</span><div class="flex-1 text-gray-700">${renderDetailData(cat, parseRecordData(r.hadir))}</div></div>`).join('') : '<p class="p-8 text-center text-gray-400 italic">Belum ada data tersimpan.</p>'}</div></div>`; }).join('')}</div></div></div>`;
            document.getElementById('backBtn').onclick = showAmalanPage;
        }

        function handleCetakGlobal(tingkat, kelas) {
            const allMerged = getMergedRecords(allRecords);
            let students = [...new Set(allMerged.map(r => JSON.stringify({nama: r.nama, kelas: r.kelas})))].map(s => JSON.parse(s));
            if (tingkat !== "Semua") students = students.filter(s => s.kelas.startsWith(tingkat));
            if (kelas !== "Semua") students = students.filter(s => s.kelas.endsWith(kelas));
            students.sort((a,b) => a.nama.localeCompare(b.nama));

            if (students.length === 0) return showToast("Tidak ada data siswa untuk filter ini", false);

            const printWindow = window.open('', '_blank');
            const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            let html = `<html><head><title>Rekapitulasi Amalan Ramadhan</title><style>
                body { font-family: Arial, sans-serif; padding: 30px; color: #333; }
                .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 12px; }
                th { background: #eee; }
                .footer { display: flex; justify-content: flex-end; margin-top: 40px; }
                .sig { text-align: center; width: 200px; }
            </style></head><body>
                <div class="header"><h1>Rekapitulasi Amalan Ramadhan Siswa</h1><div>Filter: Tingkat ${tingkat} | Kelas ${kelas}</div><div>Tahun Pelajaran 2025/2026</div></div>
                <table><thead><tr><th>No</th><th>Nama Siswa</th><th>Kelas</th><th>Total Data</th><th>Status</th></tr></thead><tbody>`;
            
            students.forEach((s, idx) => {
                const count = allMerged.filter(r => r.nama === s.nama && r.kelas === s.kelas).length;
                html += `<tr><td>${idx+1}</td><td>${s.nama}</td><td>${s.kelas}</td><td>${count}</td><td>${count > 0 ? 'Aktif' : 'Belum Ada'}</td></tr>`;
            });

            html += `</tbody></table>
                <div class="footer"><div class="sig"><div>Sumedang, ${dateStr}</div><div style="font-weight:bold; margin-bottom: 60px;">Guru PAI</div><div>( ........................................ )</div></div></div>
                <script>window.onload = () => window.print();<\/script></body></html>`;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function showCetakDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4 transition-opacity duration-200';
            overlay.style.opacity = '0';
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all duration-200 scale-95';
            modal.innerHTML = `<h3 class="text-xl font-black text-gray-800 mb-4 border-b pb-2">Opsi Cetak Laporan</h3><div class="space-y-4 mb-6 text-sm"><div><label class="block font-bold text-gray-600 mb-1">Pilih Tingkat</label><select id="selTingkat" class="w-full p-2 border rounded-lg bg-gray-50"><option value="Semua">Semua Tingkat</option><option value="7">Tingkat 7</option><option value="8">Tingkat 8</option><option value="9">Tingkat 9</option></select></div><div><label class="block font-bold text-gray-600 mb-1">Pilih Kelas</label><select id="selKelas" class="w-full p-2 border rounded-lg bg-gray-50"><option value="Semua">Semua Kelas (A-J)</option>${['A','B','C','D','E','F','G','H','I','J'].map(k => `<option value="${k}">Kelas ${k}</option>`).join('')}</select></div></div><div class="flex gap-2"><button class="modal-cancel-btn flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl">Batal</button><button class="modal-print-btn flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg">üñ®Ô∏è Cetak</button></div>`;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            requestAnimationFrame(() => { overlay.style.opacity = '1'; modal.classList.add('scale-100'); });
            const close = () => { overlay.style.opacity = '0'; setTimeout(() => overlay.remove(), 200); };
            overlay.querySelector('.modal-cancel-btn').onclick = close;
            overlay.querySelector('.modal-print-btn').onclick = () => { const tingkat = modal.querySelector('#selTingkat').value; const kelas = modal.querySelector('#selKelas').value; close(); handleCetakGlobal(tingkat, kelas); };
        }

        function showLaporanPage() {
            const allMerged = getMergedRecords(allRecords);
            const allS = [...new Set(allMerged.map(r => JSON.stringify({nama: r.nama, kelas: r.kelas})))].map(s => JSON.parse(s)).sort((a,b) => a.nama.localeCompare(b.nama));
            
            document.getElementById('app').innerHTML = `
                <div class="w-full h-full overflow-auto bg-slate-100 p-4 md:p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <h1 class="font-black text-2xl text-slate-800 flex items-center gap-2">üìã PANEL GURU</h1>
                            <div class="flex flex-wrap gap-2">
                                <button id="syncBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">üîÑ REFRESH</button>
                                ${hasInfoFiles ? `<button id="infoBtn" class="px-4 py-2 bg-amber-500 text-white rounded-lg font-bold flex items-center gap-2">‚ÑπÔ∏è INFORMASI</button>` : ''}
                                <button id="cetakGlobalBtn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold flex items-center gap-2">üñ®Ô∏è CETAK LAPORAN</button>
                                <button id="adminLogOut" class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold">KELUAR</button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-md mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">Tingkatan</label>
                                    <select id="filterTingkat" class="w-full p-2 border-2 border-gray-100 rounded-xl bg-gray-50 outline-none focus:border-emerald-500">
                                        <option value="all">Semua Tingkat</option>
                                        <option value="7">Kelas 7</option>
                                        <option value="8">Kelas 8</option>
                                        <option value="9">Kelas 9</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">Kelas</label>
                                    <select id="filterKelas" class="w-full p-2 border-2 border-gray-100 rounded-xl bg-gray-50 outline-none focus:border-emerald-500">
                                        <option value="all">Semua Kelas (A-J)</option>
                                        ${['A','B','C','D','E','F','G','H','I','J'].map(k => `<option value="${k}">${k}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-black text-gray-400 mb-1 uppercase tracking-widest">Cari Nama</label>
                                    <input type="text" id="searchNama" class="w-full p-2 border-2 border-gray-100 rounded-xl bg-gray-50 outline-none focus:border-emerald-500" placeholder="Ketik nama siswa...">
                                </div>
                            </div>
                        </div>

                        <div id="studentListGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>`;

            let filterT = 'all', filterK = 'all', searchN = '';

            const renderFilteredStudents = () => {
                const filtered = allS.filter(s => {
                    const matchT = filterT === 'all' || s.kelas.startsWith(filterT);
                    const matchK = filterK === 'all' || s.kelas.endsWith(filterK);
                    const matchN = s.nama.toLowerCase().includes(searchN.toLowerCase());
                    return matchT && matchK && matchN;
                });

                const grid = document.getElementById('studentListGrid');
                if (filtered.length === 0) {
                    grid.innerHTML = `<div class="col-span-full p-12 bg-white rounded-2xl text-center text-gray-400 italic">Siswa tidak ditemukan.</div>`;
                    return;
                }

                grid.innerHTML = filtered.map(s => `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border hover:border-emerald-500 cursor-pointer transition-all student-card" data-n="${s.nama}" data-k="${s.kelas}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-black text-gray-800">${s.nama}</h3>
                                <p class="text-xs font-bold text-emerald-600 mt-1">Kelas: ${s.kelas}</p>
                            </div>
                            <span class="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-1 rounded-lg font-bold border border-emerald-100">Lihat Rincian</span>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-3 flex items-center gap-1"><span>üìë</span> Klik untuk detail amalan lengkap</p>
                    </div>`).join('');

                grid.querySelectorAll('.student-card').forEach(c => c.onclick = (e) => {
                    const d = e.currentTarget.dataset;
                    showStudentDetail({ nama: d.n, kelas: d.k });
                });
            };

            document.getElementById('filterTingkat').onchange = (e) => { filterT = e.target.value; renderFilteredStudents(); };
            document.getElementById('filterKelas').onchange = (e) => { filterK = e.target.value; renderFilteredStudents(); };
            document.getElementById('searchNama').oninput = (e) => { searchN = e.target.value; renderFilteredStudents(); };
            
            document.getElementById('syncBtn').onclick = fetchAllDataForAdmin;
            if(document.getElementById('infoBtn')) {
                document.getElementById('infoBtn').onclick = () => window.open(INFO_DRIVE_URL, '_blank');
            }
            document.getElementById('cetakGlobalBtn').onclick = showCetakDialog;
            document.getElementById('adminLogOut').onclick = handleLogout;

            renderFilteredStudents();
        }

        function handleCetakLaporanIndividual(student, dataRaw) {
            const data = getMergedRecords(dataRaw);
            const printWindow = window.open('', '_blank');
            const dateStr = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            let html = `<html><head><title>Laporan - ${student.nama}</title><style>
                body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
                .header { text-align: center; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 25px; }
                .info { margin-bottom: 20px; }
                .tbl { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
                .tbl th, .tbl td { border: 1px solid #000; padding: 8px; text-align: left; font-size: 13px; }
                .tbl th { background: #f2f2f2; }
                .footer { margin-top: 40px; display: flex; justify-content: flex-end; }
                .sig { text-align: center; width: 250px; }
            </style></head><body>
                <div class="header"><h1>LAPORAN AMALAN RAMADHAN SISWA</h1><div>Tahun 1447 H / 2026 M</div></div>
                <div class="info"><b>Nama:</b> ${student.nama}<br><b>Kelas:</b> ${student.kelas}</div>`;
            
            categories.forEach(cat => {
                const recs = data.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal));
                if(recs.length > 0) {
                    html += `<h3>${getCategoryIcon(cat)} ${cat}</h3><table class="tbl"><thead><tr><th width="80">Hari Ke-</th><th>Keterangan Amalan</th></tr></thead><tbody>`;
                    recs.forEach(r => { html += `<tr><td>${r.tanggal}</td><td>${renderDetailData(cat, parseRecordData(r.hadir))}</td></tr>`; });
                    html += `</tbody></table>`;
                }
            });

            html += `<div class="footer"><div class="sig"><div>Mengetahui,</div><div style="margin-bottom: 5px;">Sumedang, ${dateStr}</div><div style="font-weight:bold;">Guru PAI</div><div style="height:70px;"></div><div style="font-weight:bold;">( ........................................ )</div><div style="font-size:11px;">NIP. ................................</div></div></div>
                <script>window.onload = () => window.print();<\/script></body></html>`;
            printWindow.document.write(html);
            printWindow.document.close();
        }

        function showStudentDetail(s) {
            const dataRaw = allRecords.filter(r => r.nama === s.nama && r.kelas === s.kelas);
            const data = getMergedRecords(dataRaw);

            document.getElementById('app').innerHTML = `
                <div class="w-full h-full overflow-auto bg-slate-50 p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div><h2 class="font-black text-2xl text-slate-800">${s.nama}</h2><p class="font-bold text-emerald-600 italic">Kelas: ${s.kelas}</p></div>
                            <div class="flex gap-2">
                                <button id="individualCetak" class="px-5 py-2 bg-emerald-600 text-white rounded-xl font-bold shadow-md flex items-center gap-2">üñ®Ô∏è CETAK LAPORAN</button>
                                <button id="backAdmin" class="px-5 py-2 bg-slate-800 text-white rounded-xl font-bold shadow-md">‚Üê KEMBALI</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${categories.map(cat => {
                                const recs = data.filter(r => r.kategori === cat).sort((a,b) => parseInt(a.tanggal) - parseInt(b.tanggal));
                                return `<div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="font-black border-b pb-2 mb-4 text-slate-700">${getCategoryIcon(cat)} ${cat}</h3><div class="space-y-2">${recs.length ? recs.map(r => `<div class="text-xs p-3 bg-slate-50 rounded-lg border border-slate-100"><strong>Hari ke-${r.tanggal}:</strong><br>${renderDetailData(cat, parseRecordData(r.hadir))}</div>`).join('') : '<p class="text-xs text-gray-400">Belum ada data.</p>'}</div></div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            document.getElementById('backAdmin').onclick = showLaporanPage;
            document.getElementById('individualCetak').onclick = () => handleCetakLaporanIndividual(s, dataRaw);
        }

        function getCategoryIcon(k) { switch(k) { case 'Shalat Fardu': return 'üïå'; case 'Tarawih': return 'üåô'; case 'Puasa': return 'üçΩÔ∏è'; case 'Tadarus': return 'üìñ'; case 'Ceramah': return 'üéôÔ∏è'; default: return 'üìù'; } }
        
        function parseRecordData(d) { try { return typeof d === 'string' ? JSON.parse(d) : d; } catch (e) { return d; } }
        
        function renderDetailData(k, d) {
            d = parseRecordData(d);
            if (!d) return '-'; 
            if (k === 'Shalat Fardu') {
                if (typeof d !== 'object') return d;
                const orderedKeys = ['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
                const entries = orderedKeys.filter(key => d[key]).map(key => `${key}: <span class="font-bold text-emerald-600">${d[key]}</span>`);
                return entries.length ? entries.join(' | ') : '-';
            } else if (k === 'Tarawih') return `Status: <b>${d.status || '-'}</b>, Lokasi: <b>${d.tempat || '-'}</b>`;
            else if (k === 'Puasa') return `Status: <b>${typeof d === 'string' ? d : (d.status || '-')}</b>`;
            else if (k === 'Tadarus') return `Metode: <b>${d.pilihan || '-'}</b>, Surat: <b>${d.surat || '-'}</b> (${d.ayat || '-'})`;
            else if (k === 'Ceramah') return `Penceramah: <b>${d.penceramah || '-'}</b>, Lokasi: <b>${d.tempat || '-'}</b><br><span class="text-xs text-slate-500 italic">"${d.ringkasan || '-'}"</span>`;
            return JSON.stringify(d);
        }

        async function init() { 
            loadAllRecords(); 
            const saved = safeGetStorage('ramadhanUser'); 
            
            // Cek apakah sudah terdaftar (punya ID Sekolah)
            if (!SCHOOL_ID) {
                renderRegistration();
            } else {
                if (saved) { 
                    try { 
                        currentUser = JSON.parse(saved); 
                        loadUserState(); 
                        showAmalanPage(); 
                        if (!isAdmin()) setTimeout(syncUserFromCloud, 500); 
                    } catch (e) { 
                        safeRemoveStorage('ramadhanUser'); 
                        currentUser = null; 
                        showLoginPage(); 
                    } 
                } else { 
                    showLoginPage(); 
                }
            }
            if (window.dataSdk) await window.dataSdk.init({ onDataChanged(d) { allRecords = d; saveAllRecords(); } }); 
            if (window.elementSdk) window.elementSdk.init({ defaultConfig, onConfigChange: (c) => Object.assign(window.elementSdk.config, c) }); 
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
  </script>
 </body>
</html>
